<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <title>Tone generator</title>

        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>

        <script type="text/javascript">
            function Oscillator(description, generator) {
                this.description = description;
                this.generator = generator;
            }


            var oscillators = {
                "sine" : new Oscillator(
                    "Sine", Math.sin
                ),
                "square" : new Oscillator(
                    "Square",
                    function(theta) {
                        if (0 <= theta && theta <= Math.PI) {
                            return 1;
                        } else if (Math.PI <= theta && theta <= 2 * Math.PI) {
                            return -1;
                        }
                    }
                ),
                "triangle" : new Oscillator(
                    "Triangle",
                    function(theta) { return 1 - 2 * Math.abs((theta / Math.PI) - 1) }
                ),
                "sawtooth" : new Oscillator(
                    "Sawtooth",
                    function(theta) { return theta / (Math.PI * 2) }
                ),
                "noise" : new Oscillator(
                    "Noise",
                    function() { return Math.random() * 2 - 1 }
                )
            };



            function Voice(oscillator, attack, decay, sustain, release) {
                this.oscillator = oscillator;
                this.attack = attack;
                this.decay = decay;
                this.sustain = sustain;
                this.release = release;
            }


            function Note(startTime, frequency, voice) {
                this.startTime = startTime;
                this.frequency = frequency;
                this.radiansPerSample = 2 * Math.PI * frequency / sampleRate;
                this.voice = voice;
                this.requestedStopTime = 0;
                this.actualStopTime = 0;
            }
            Note.prototype.getAmplitude = function(offset) {
                if (offset < this.startTime) {
                    return 0;
                }
                var t = offset - this.startTime;
                if (t <= this.voice.attack) {
                    return t / this.voice.attack;
                }
                if (t <= this.voice.attack + this.voice.decay) {
                    return 1 - (((1 - this.voice.sustain) * (t - this.voice.attack)) / this.voice.decay);
                }
                if (this.requestedStopTime == 0) {
                    return this.voice.sustain;
                }
                // We ignore requests to stop until the attack/decay is complete; this means that
                // our release can actually start later than requested
                if (this.actualStopTime == 0) {
                    this.actualStopTime = offset;
                }
                if (offset < this.actualStopTime + this.voice.release) {
                    return this.voice.sustain - ((this.voice.sustain * (offset - this.actualStopTime)) / this.voice.release);
                }
                return 0;
            }




            var sampleRate = 44100;
            var portionSize = sampleRate / 100;
            var prebufferSize = sampleRate / 4;
            var play = false;
            var writeInterval = Math.floor(1000 * portionSize / sampleRate);

            var audio;
            var currentWritePosition = 0;

            var note = null;


            function getSoundData(offset, size) {
                var soundData = new Float32Array(size);
                if (note != null) {
                    for (var i=0; i < size; i++) {
                        var tick = (i + offset);
                        var theta = (note.radiansPerSample * tick) % (2 * Math.PI);
                        soundData[i] = note.voice.oscillator.generator(theta) * note.getAmplitude(tick);
                    }
                }
                return soundData;
            }

            function writeData() {
                while (audio.mozCurrentSampleOffset() + prebufferSize >= currentWritePosition) {
                    var soundData = getSoundData(currentWritePosition, portionSize);
                    audio.mozWriteAudio(soundData);
                    currentWritePosition += portionSize;
                }
            }

            function start() {
                note = new Note(
                    currentWritePosition,
                    parseFloat($("#id_freq").val()),
                    new Voice(
                        oscillators[$("#id_oscillator").val()],
                        parseFloat($("#id_attack").val()),
                        parseFloat($("#id_decay").val()),
                        parseFloat($("#id_sustain").val()),
                        parseFloat($("#id_release").val())
                    )
                );
            }

            function stop() {
                if (note != null) {
                    note.requestedStopTime = currentWritePosition;
                }
            }

            function init() {
                audio = new Audio();
                audio.mozSetup(1, sampleRate, 1);

                for (oscillator in oscillators) {
                    $("#id_oscillator").append('<option value="' + oscillator + '">' + oscillators[oscillator].description + '</option>');
                }

                $("#id_play").mousedown(start);
                $("#id_play").mouseup(stop);

                setInterval(writeData, writeInterval);
            }

            $(init);
        </script>
    </head>

    <body>

        <table>
            <tr>
                <td>
                    <select id="id_oscillator">
                    </select>
                </td>
                <td>
                    <input type="text" size="4" id="id_freq" value="440"><label for="hz">Hz</label>
                </td>
            </tr>
            <tr>
                <td>
                    Attack:
                </td>
                <td>
                    <input type="text" size="4" id="id_attack" value="1000"> ticks
                </td>
            </tr>
            <tr>
                <td>
                    Decay:
                </td>
                <td>
                    <input type="text" size="4" id="id_decay" value="1000"> ticks
                </td>
            </tr>
            <tr>
                <td>
                    Sustain:
                </td>
                <td>
                    <input type="text" size="4" id="id_sustain" value="0.5"> (amplitude, 0-1)
                </td>
            </tr>
            <tr>
                <td>
                    Release:
                </td>
                <td>
                    <input type="text" size="4" id="id_release" value="10000"> ticks
                </td>
            </tr>
            <tr>
                <td>
                    <button id="id_play">play</button>
                </td>
            </tr>
        </table>

        <p>
        Based on <a href="https://wiki.mozilla.org/Audio_Data_API#Complete_Example:_Creating_a_Web_Based_Tone_Generator">this Firefox Audio Data API demo</a>.
        Inspiration from <a href="http://forums.dv247.com/tips-n-tricks-general-production/1079-synthesis-101-basics.html">this synthesizer 101 post</a>, and,
        of course, <a href="http://en.wikipedia.org/wiki/Synthesizer">Wikipedia</a>.

        <p>
        This page is under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike license (CC-BY-SA)</a>.

        <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
        </script>
        <script type="text/javascript">
            try {
                var pageTracker = _gat._getTracker("UA-2240015-3");
                pageTracker._trackPageview();
            } catch(err) {}
        </script>

    </body>
</html>
