<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <title>Tone generator</title>

        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>

        <script type="text/javascript">
            function ToneType(description, generator) {
                this.description = description;
                this.generator = generator;
            }


            var toneTypes = {
                "sine" : new ToneType(
                    "Sine", Math.sin
                ),
                "square" : new ToneType(
                    "Square",
                    function(theta) {
                        if (0 <= theta && theta <= Math.PI) {
                            return 1;
                        } else if (Math.PI <= theta && theta <= 2 * Math.PI) {
                            return -1;
                        }
                    }
                ),
                "triangle" : new ToneType(
                    "Triangle",
                    function(theta) { return 1 - 2 * Math.abs((theta / Math.PI) - 1) }
                ),
                "sawtooth" : new ToneType(
                    "Sawtooth",
                    function(theta) { return theta / (Math.PI * 2) }
                ),
                "noise" : new ToneType(
                    "Noise",
                    function() { return Math.random() * 2 - 1 }
                )
            };


            function Note(startTime, attack, decay, sustain, release) {
                this.startTime = startTime;
                this.attack = attack;
                this.decay = decay;
                this.sustain = sustain;
                this.release = release;
                this.stopTime = 0;
            }
            Note.prototype.getAmplitude = function(offset) {
                if (offset < this.startTime) {
                    return 0;
                }
                var t = offset - this.startTime;
                if (t <= this.attack) {
                    return t / this.attack;
                }
                if (t <= this.attack + this.decay) {
                    return 1 - (((1 - this.sustain) * (t - this.attack)) / this.decay);
                }
                if (this.stopTime == 0) {
                    return this.sustain;
                }
                if (offset < this.stopTime + this.release) {
                    return this.sustain - ((this.sustain * (offset - this.stopTime)) / this.release);
                }
                return 0;
            }




            var sampleRate = 44100;
            var portionSize = sampleRate / 100;
            var prebufferSize = sampleRate / 4;
            var play = false;
            var writeInterval = Math.floor(1000 * portionSize / sampleRate);

            var audio;
            var currentWritePosition = 0;

            var note = null;


            function getSoundData(offset, size) {
                var soundData = new Float32Array(size);
                var toneType = toneTypes[$("#id_wave").val()];
                var freq = parseFloat($("#id_freq").val());
                if (freq && note != null) {
                    var k = 2 * Math.PI * freq / sampleRate;
                    for (var i=0; i < size; i++) {
                        var tick = (i + offset);
                        var theta = (k * tick) % (2 * Math.PI);
                        soundData[i] = toneType.generator(theta) * note.getAmplitude(tick);
                    }
                }
                return soundData;
            }

            function writeData() {
                while (audio.mozCurrentSampleOffset() + prebufferSize >= currentWritePosition) {
                    var soundData = getSoundData(currentWritePosition, portionSize);
                    audio.mozWriteAudio(soundData);
                    currentWritePosition += portionSize;
                }
            }

            function start() {
                note = new Note(
                    currentWritePosition,
                    parseFloat($("#id_attack").val()),
                    parseFloat($("#id_decay").val()),
                    parseFloat($("#id_sustain").val()),
                    parseFloat($("#id_release").val())
                );
            }

            function stop() {
                if (note != null) {
                    note.stopTime = currentWritePosition;
                }
            }

            function init() {
                audio = new Audio();
                audio.mozSetup(1, sampleRate, 1);

                for (toneType in toneTypes) {
                    $("#id_wave").append('<option value="' + toneType + '">' + toneTypes[toneType].description + '</option>');
                }

                $("#id_play").mousedown(start);
                $("#id_play").mouseup(stop);

                setInterval(writeData, writeInterval);
            }

            $(init);
        </script>
    </head>

    <body>

        <table>
            <tr>
                <td>
                    <select id="id_wave">
                    </select>
                </td>
                <td>
                    <input type="text" size="4" id="id_freq" value="440"><label for="hz">Hz</label>
                </td>
            </tr>
            <tr>
                <td>
                    Attack:
                </td>
                <td>
                    <input type="text" size="4" id="id_attack" value="1000"> ticks
                </td>
            </tr>
            <tr>
                <td>
                    Decay:
                </td>
                <td>
                    <input type="text" size="4" id="id_decay" value="1000"> ticks
                </td>
            </tr>
            <tr>
                <td>
                    Sustain:
                </td>
                <td>
                    <input type="text" size="4" id="id_sustain" value="0.5"> (amplitude, 0-1)
                </td>
            </tr>
            <tr>
                <td>
                    Release:
                </td>
                <td>
                    <input type="text" size="4" id="id_release" value="10000"> ticks
                </td>
            </tr>
            <tr>
                <td>
                    <button id="id_play">play</button>
                </td>
            </tr>
        </table>

        <p>
        Based on <a href="https://wiki.mozilla.org/Audio_Data_API#Complete_Example:_Creating_a_Web_Based_Tone_Generator">this Firefox Audio Data API demo</a>.
        Inspiration from <a href="http://forums.dv247.com/tips-n-tricks-general-production/1079-synthesis-101-basics.html">this synthesizer 101 post</a>, and,
        of course, <a href="http://en.wikipedia.org/wiki/Synthesizer">Wikipedia</a>.

        <p>
        This page is under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike license (CC-BY-SA)</a>.

        <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
        </script>
        <script type="text/javascript">
            try {
                var pageTracker = _gat._getTracker("UA-2240015-3");
                pageTracker._trackPageview();
            } catch(err) {}
        </script>

    </body>
</html>
