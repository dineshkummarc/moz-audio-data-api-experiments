<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <title>Tone generator</title>

        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>

        <script type="text/javascript">
            var sampleRate = 44100;
            var portionSize = sampleRate / 10;
            var prebufferSize = sampleRate / 2;
            var play = false;
            var writeInterval = Math.floor(1000 * portionSize / sampleRate);

            var audio;
            var currentWritePosition = 0;

            function getSoundData(offset, size) {
                var soundData = new Float32Array(size);
                var wave = $("#id_wave").val();
                var freq = parseFloat($("#id_freq").val());
                if (freq) {
                    var k = 2 * Math.PI * freq / sampleRate;
                    for (var i=0; i < size; i++) {
                        var theta = (k * (i + offset)) % (2 * Math.PI);
                        if (wave == "sine") {
                            soundData[i] = Math.sin(theta);
                        } else if (wave == "square") {
                            if (0 <= theta && theta <= Math.PI) {
                                soundData[i] = 1;
                            } else if (Math.PI <= theta && theta <= 2 * Math.PI) {
                                soundData[i] = -1;
                            }
                        } else if (wave == "triangle") {
                            soundData[i] = 1 - 2 * Math.abs((theta / Math.PI) - 1);
                        } else if (wave == "sawtooth") {
                            soundData[i] = theta / (Math.PI * 2);
                        } else {
                            soundData[i] = 0;
                        }
                    }
                }
                return soundData;
            }

            function writeData() {
                while (audio.mozCurrentSampleOffset() + prebufferSize >= currentWritePosition) {
                    var soundData = getSoundData(currentWritePosition, portionSize);
                    audio.mozWriteAudio(soundData);
                    currentWritePosition += portionSize;
                }
                if (play) {
                    setTimeout(writeData, writeInterval);
                }
            }

            function start() {
                play = true;
                setTimeout(writeData, writeInterval);
            }

            function stop() {
                play = false;
            }

            function init() {
                audio = new Audio();
                audio.mozSetup(1, sampleRate, 1);
            }

            $(init);
        </script>
    </head>

    <body>

        <table>
            <tr>
                <td>
                    <select id="id_wave">
                        <option value="sine" checked>Sine</option>
                        <option value="square">Square</option>
                        <option value="triangle">Triangle</option>
                        <option value="sawtooth">Sawtooth</option>
                    </select>
                </td>
                <td>
                    <input type="text" size="4" id="id_freq" value="440"><label for="hz">Hz</label>
                </td>
                <td>
                    <button onclick="start()">play</button>
                </td>
                <td>
                    <button onclick="stop()">stop</button>
                </td>
            </tr>
    </body>
</html>
